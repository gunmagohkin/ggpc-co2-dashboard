<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Energy vs Goods Produced</title>
  <link rel="icon" type="image/x-icon" href="images/gkg.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .custom-scroll::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    .custom-scroll::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
    }
    .rotate-180 { 
        transform: rotate(180deg);
    }
    /* Toggle Switch CSS */
    .toggle-checkbox:checked {
        transform: translateX(100%);
        background-color: #2563eb; /* blue-600 */
        border-color: #2563eb; /* blue-600 */
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #60a5fa; /* blue-400 */
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

<!-- Navigation -->
<nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
  <div class="mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo and Title -->
      <div class="flex items-center space-x-3 min-w-0">
        <a href="#" class="flex-shrink-0">
            <img src="images/GGPC logo.png" alt="Company Logo" class="h-10 sm:h-12 w-auto">
        </a>
      </div>

      <!-- Desktop Navigation -->
       <div class="hidden lg:flex items-center space-x-2">
        <a href="energy_vs_goods.html" class="font-semibold text-blue-600 px-3 py-2 rounded-md bg-blue-50">Energy vs Goods</a>
        <a href="vsruntime.html" class="font-semibold text-gray-600 px-3 py-2 rounded-md hover:bg-gray-100 hover:text-blue-600">Energy vs Runtime</a>
        <a href="co2.html" class="font-semibold text-gray-600 px-3 py-2 rounded-md hover:bg-gray-100 hover:text-blue-600">CO2 Emission</a>
        <a href="ggpcvscdpc.html" class="font-semibold text-gray-600 px-3 py-2 rounded-md hover:bg-gray-100 hover:text-blue-600">GGPC vs CDPC</a>
      </div>

      <!-- Mobile menu button -->
      <div class="lg:hidden">
        <button id="menu-btn" class="focus:outline-none p-2 rounded-md text-gray-600 hover:text-blue-600 hover:bg-gray-100">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Navigation -->
  <div id="mobile-menu" class="lg:hidden transition-all duration-300 ease-in-out max-h-0 overflow-hidden bg-white">
    <div class="px-4 sm:px-6 pb-4 pt-2 border-t space-y-2">
        <a href="energy_vs_goods.html" class="block font-semibold text-blue-600 py-2">Energy vs Goods</a>
        <a href="vsruntime.html" class="block font-semibold text-gray-600 py-2">Energy vs Runtime</a>
        <a href="co2.html" class="block font-semibold text-gray-600 py-2">CO2 Emission</a>
        <a href="ggpcvscdpc.html" class="block font-semibold text-gray-600 py-2">GGPC vs CDPC</a>
    </div>
  </div>
</nav>

<!-- Main Content -->
<main class="p-4 sm:p-6 lg:p-8">
  <div class="mx-auto">
      
      <!-- Header Section -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <!-- Title -->
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Energy vs Goods Produced</h1>
            <p class="text-sm text-gray-500">Analysis of energy consumption against production output.</p>
        </div>
        
        <!-- Controls Section -->
        <div class="flex items-center gap-3">
            <label for="year-select" class="text-sm font-medium text-gray-700">Year:</label>
            <div class="relative">
                <select id="year-select" class="w-full sm:w-auto appearance-none border border-gray-300 rounded-lg px-4 py-2 pr-8 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition bg-white">
                  <!-- dynamically populated -->
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-500 transition-transform duration-300">
                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                </div>
            </div>
        </div>
      </div>

    <div class="space-y-8">
        <!-- GGPC Section -->
        <div>
            <div class="flex items-center gap-3 mb-4">
                <!-- <h2 class="text-xl font-bold text-gray-700">GGPC Data</h2> -->
                <span class="text-sm font-semibold text-red-600 bg-red-100 px-2 py-1 rounded-full">GGPC Data</span>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto custom-scroll">
                <table id="ggpcTable" class="min-w-full text-xs border-collapse">
                    <thead class="bg-gray-50 text-[10px] uppercase">
                        <tr>
                            <th class="px-2 py-2 border font-semibold">Month</th>
                            <th colspan="2" class="px-2 py-2 border bg-blue-50">Ingot Used</th>
                            <th class="px-2 py-2 border bg-green-50">Goods Produced</th>
                            <th colspan="2" class="px-2 py-2 border bg-yellow-50">Electricity</th>
                            <th colspan="3" class="px-2 py-2 border bg-orange-50">LPG</th>
                            <th colspan="4" class="px-2 py-2 border bg-purple-50">Fuel</th>
                            <th colspan="5" class="px-2 py-2 border bg-indigo-50">Oil Usage (Liters)</th>
                            <th rowspan="2" class="px-2 py-2 border bg-teal-50">Energy Intensity<br>(KWh/Kg)</th>
                            <th rowspan="2" class="px-2 py-2 border bg-gray-200">Ops Eq.<br>(t-CO2)</th>
                            <th rowspan="2" class="px-2 py-2 border bg-gray-200">CO2 Intensity<br>(CO2/pc)</th>
                            <th rowspan="2" class="px-2 py-2 border bg-gray-200">CO2 Intensity<br>(CO2/Kg)</th>
                        </tr>
                        <tr class="bg-gray-100 font-semibold">
                            <th class="border"></th>
                            <th class="p-2 text-center border bg-blue-50">Pcs</th>
                            <th class="p-2 text-center border bg-blue-50">Kg</th>
                            <th class="p-2 text-center border bg-green-50">Kg</th>
                            <th class="p-2 text-center border bg-yellow-50">KWhr</th>
                            <th class="p-2 text-center border bg-yellow-50">CO2</th>
                            <th class="p-2 text-center border bg-orange-50">Kg</th>
                            <th class="p-2 text-center border bg-orange-50">KWhr</th>
                            <th class="p-2 text-center border bg-orange-50">CO2</th>
                            <th class="p-2 text-center border bg-purple-50">Gasoline</th>
                            <th class="p-2 text-center border bg-purple-50">Gas CO2</th>
                            <th class="p-2 text-center border bg-purple-50">Diesel</th>
                            <th class="p-2 text-center border bg-purple-50">Diesel CO2</th>
                            <th class="p-2 text-center border bg-indigo-50">Tellus 46</th>
                            <th class="p-2 text-center border bg-indigo-50">Tellus 32</th>
                            <th class="p-2 text-center border bg-indigo-50">EP-220</th>
                            <th class="p-2 text-center border bg-indigo-50">PL-1000</th>
                            <th class="p-2 text-center border bg-indigo-50">Oil CO2</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- CDPC Section -->
        <div>
             <div class="flex items-center gap-3 mb-4">
                <!-- <h2 class="text-xl font-bold text-gray-700">CDPC Data</h2> -->
                <span class="text-sm font-semibold text-red-600 bg-red-100 px-2 py-1 rounded-full">CDPC Data</span>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto custom-scroll">
                 <table id="cdpcTable" class="min-w-full text-xs border-collapse">
                    <thead class="bg-gray-50 text-[10px] uppercase">
                        <tr>
                            <th class="px-2 py-2 border font-semibold">Month</th>
                            <th colspan="2" class="px-2 py-2 border bg-blue-50">Ingot Used</th>
                            <th class="px-2 py-2 border bg-green-50">Goods Produced</th>
                            <th colspan="2" class="px-2 py-2 border bg-yellow-50">Electricity</th>
                            <th colspan="3" class="px-2 py-2 border bg-orange-50">LPG</th>
                            <th colspan="4" class="px-2 py-2 border bg-purple-50">Fuel</th>
                            <th colspan="5" class="px-2 py-2 border bg-indigo-50">Oil Usage (Liters)</th>
                            <th rowspan="2" class="px-2 py-2 border bg-teal-50">Energy Intensity<br>(KWh/Kg)</th>
                            <th rowspan="2" class="px-2 py-2 border bg-gray-200">Ops Eq.<br>(t-CO2)</th>
                            <th rowspan="2" class="px-2 py-2 border bg-gray-200">CO2 Intensity<br>(CO2/pc)</th>
                            <th rowspan="2" class="px-2 py-2 border bg-gray-200">CO2 Intensity<br>(CO2/Kg)</th>
                        </tr>
                        <tr class="bg-gray-100 font-semibold">
                            <th class="border"></th>
                            <th class="p-2 text-center border bg-blue-50">Pcs</th>
                            <th class="p-2 text-center border bg-blue-50">Kg</th>
                            <th class="p-2 text-center border bg-green-50">Kg</th>
                            <th class="p-2 text-center border bg-yellow-50">KWhr</th>
                            <th class="p-2 text-center border bg-yellow-50">CO2</th>
                            <th class="p-2 text-center border bg-orange-50">Kg</th>
                            <th class="p-2 text-center border bg-orange-50">KWhr</th>
                            <th class="p-2 text-center border bg-orange-50">CO2</th>
                            <th class="p-2 text-center border bg-purple-50">Gasoline</th>
                            <th class="p-2 text-center border bg-purple-50">Gas CO2</th>
                            <th class="p-2 text-center border bg-purple-50">Diesel</th>
                            <th class="p-2 text-center border bg-purple-50">Diesel CO2</th>
                            <th class="p-2 text-center border bg-indigo-50">Tellus 46</th>
                            <th class="p-2 text-center border bg-indigo-50">Tellus 32</th>
                            <th class="p-2 text-center border bg-indigo-50">EP-220</th>
                            <th class="p-2 text-center border bg-indigo-50">PL-1000</th>
                            <th class="p-2 text-center border bg-indigo-50">Oil CO2</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- Chart Section -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Energy Consumption Charts</h2>
                 <div class="flex items-center gap-3 mt-4 md:mt-0">
                    <label for="stackToggle" class="text-sm font-medium text-gray-700">Stack Energy Data</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="stackToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-transform duration-200 ease-in-out"/>
                        <label for="stackToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-200 ease-in-out"></label>
                    </div>
                 </div>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="chart-container"><canvas id="ggpcEnergyChart"></canvas></div>
                <div class="chart-container"><canvas id="cdpcEnergyChart"></canvas></div>
            </div>
        </div>
    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- UTILITY FUNCTIONS ---
    function mapRecord(r) {
      return {
        dateFrom: r.Date_To?.value || '',
        inggotUsedPcs: parseFloat(r.Inggot_used_pcs?.value || 0),
        inggotUsedKg: parseFloat(r.Inggot_Used_Kg?.value || 0),
        goodsProducedKg: parseFloat(r.Goods_Produced_Kg?.value || 0),
        electricityKWh: parseFloat(r.Electricity_KWhr?.value || 0),
        electricityCO2: parseFloat(r.Electricity_CO2?.value || 0),
        lpgKg: parseFloat(r.LPG_Total_Kg?.value || 0),
        lpgKWh: parseFloat(r.LPG_KWhr?.value || 0),
        lpgCO2: parseFloat(r.lpg_co2?.value || 0),
        gasolineLiters: parseFloat(r.Gasoline_Liters?.value || 0),
        gasCO2: parseFloat(r.Gas_CO2?.value || 0),
        dieselLiters: parseFloat(r.Diesel_Liters?.value || 0),
        dieselCO2: parseFloat(r.Diesel_CO2?.value || 0),
        tellus46: parseFloat(r.Tellus_46?.value || 0),
        tellus32: parseFloat(r.Tellus_32?.value || 0),
        ep220: parseFloat(r.EP_220?.value || 0),
        pl1000: parseFloat(r.PL_1000?.value || 0),
        oilCO2: parseFloat(r.OIL_CO2?.value || 0),
        energyIntensity: parseFloat(r.Energy_Intensity?.value || 0),
        operationsEquivalent: parseFloat(r.Operations_equivalent?.value || 0),
        co2IntensityPc: parseFloat(r.CO2_Intensity_pc?.value || 0),
        co2IntensityKg: parseFloat(r.CO2_Intensity_kg?.value || 0)
      };
    }

    async function fetchKintoneData(endpoint) {
      const response = await fetch(endpoint);
      if (!response.ok) throw new Error('Failed to fetch data');
      return response.json();
    }

    function formatDateToMonth(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString('en-US', { month: 'short' }).toUpperCase();
    }

    function renderTableRows(tableId, data) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = ''; 
      data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        row.forEach((cell, cellIndex) => {
          const td = document.createElement('td');
          if (typeof cell === 'number' && !isNaN(cell)) {
            td.textContent = Number.isInteger(cell) ? cell.toLocaleString('en-US') : cell.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          } else {
            td.textContent = cell;
          }
          td.className = 'px-2 py-1 border text-center';
          if (cellIndex === 0) td.classList.add('font-semibold', 'bg-gray-50');
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function createEnergyChart(ctx, title, goodsProducedKg, electricityKWh, lpgKWh, stacked = false) {
      const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Goods Produced (Kg)', data: goodsProducedKg, type: 'line', borderColor: '#3B82F6', backgroundColor: '#3B82F6', yAxisID: 'y', tension: 0.1, fill: false, pointStyle: 'circle', pointRadius: 5, pointBackgroundColor: '#3B82F6'
            },
            {
              label: 'Electricity KWh', data: electricityKWh, backgroundColor: '#F97316', yAxisID: 'y1', barPercentage: 0.7, categoryPercentage: 0.6, stack: stacked ? 'energy' : undefined
            },
            {
              label: 'LPG KWh', data: lpgKWh, backgroundColor: '#6B7280', yAxisID: 'y1', barPercentage: 0.7, categoryPercentage: 0.6, stack: stacked ? 'energy' : undefined
            }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            y: { type: 'linear', position: 'left', title: { display: true, text: 'Kilograms' }, ticks: { callback: value => value.toLocaleString() }, min: 0 },
            y1: { type: 'linear', position: 'right', title: { display: true, text: 'KWh' }, grid: { drawOnChartArea: false }, ticks: { callback: value => value.toLocaleString() }, min: 0, stacked: stacked }
          },
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: title, font: { size: 16, weight: 'bold' } }
          }
        }
      });
    }
    
    function filterByYear(records, year) {
        return records.filter(r => new Date(r.dateFrom).getFullYear() === parseInt(year));
    }

    // --- MAIN DASHBOARD LOGIC ---
    let ggpcChart, cdpcChart;
    const kintoneData = await fetchKintoneData('/.netlify/functions/kintone');
    const ggpcRecords = kintoneData.records.filter(r => r.Plant_Location.value === 'GGPC').map(mapRecord).sort((a, b) => new Date(a.dateFrom) - new Date(b.dateFrom));
    const cdpcRecords = kintoneData.records.filter(r => r.Plant_Location.value === 'CDPC').map(mapRecord).sort((a, b) => new Date(a.dateFrom) - new Date(b.dateFrom));

    const yearSelect = document.getElementById('year-select');
    const allYears = Array.from(new Set([...ggpcRecords, ...cdpcRecords].map(r => new Date(r.dateFrom).getFullYear()))).sort((a, b) => b - a);
    
    yearSelect.innerHTML = '';
    allYears.forEach(year => {
        const opt = document.createElement('option');
        opt.value = year;
        opt.textContent = year;
        yearSelect.appendChild(opt);
    });

    function updateDashboard(selectedYear) {
      const filteredGGPC = filterByYear(ggpcRecords, selectedYear);
      const filteredCDPC = filterByYear(cdpcRecords, selectedYear);
      
      const ggpcTableData = filteredGGPC.map(r => [formatDateToMonth(r.dateFrom), r.inggotUsedPcs, r.inggotUsedKg, r.goodsProducedKg, r.electricityKWh, r.electricityCO2, r.lpgKg, r.lpgKWh, r.lpgCO2, r.gasolineLiters, r.gasCO2, r.dieselLiters, r.dieselCO2, r.tellus46, r.tellus32, r.ep220, r.pl1000, r.oilCO2, r.energyIntensity, r.operationsEquivalent, r.co2IntensityPc, r.co2IntensityKg]);
      renderTableRows('ggpcTable', ggpcTableData);
      
      const cdpcTableData = filteredCDPC.map(r => [formatDateToMonth(r.dateFrom), r.inggotUsedPcs, r.inggotUsedKg, r.goodsProducedKg, r.electricityKWh, r.electricityCO2, r.lpgKg, r.lpgKWh, r.lpgCO2, r.gasolineLiters, r.gasCO2, r.dieselLiters, r.dieselCO2, r.tellus46, r.tellus32, r.ep220, r.pl1000, r.oilCO2, r.energyIntensity, r.operationsEquivalent, r.co2IntensityPc, r.co2IntensityKg]);
      renderTableRows('cdpcTable', cdpcTableData);

      if (ggpcChart) ggpcChart.destroy();
      if (cdpcChart) cdpcChart.destroy();
      
      ggpcChart = createEnergyChart(document.getElementById('ggpcEnergyChart').getContext('2d'), 'GGPC ENERGY CONSUMPTION VS GOODS PRODUCED', filteredGGPC.map(r => r.goodsProducedKg), filteredGGPC.map(r => r.electricityKWh), filteredGGPC.map(r => r.lpgKWh), document.getElementById('stackToggle').checked);
      cdpcChart = createEnergyChart(document.getElementById('cdpcEnergyChart').getContext('2d'), 'CDPC ENERGY CONSUMPTION VS GOODS PRODUCED', filteredCDPC.map(r => r.goodsProducedKg), filteredCDPC.map(r => r.electricityKWh), filteredCDPC.map(r => r.lpgKWh), document.getElementById('stackToggle').checked);
    }
    
    document.getElementById('stackToggle').addEventListener('change', () => updateDashboard(yearSelect.value));
    yearSelect.addEventListener('change', (e) => updateDashboard(e.target.value));

    // Mobile Menu
    const menuBtn = document.getElementById('menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    menuBtn.addEventListener('click', () => {
        const isClosed = mobileMenu.style.maxHeight === '' || mobileMenu.style.maxHeight === '0px';
        mobileMenu.style.maxHeight = isClosed ? mobileMenu.scrollHeight + "px" : '0px';
    });
    
    // Dropdown icon animation
    document.querySelectorAll("select").forEach(select => {
        const iconWrapper = select.nextElementSibling;
        if (iconWrapper) {
            select.addEventListener("focus", () => iconWrapper.classList.add("rotate-180"));
            select.addEventListener("blur", () => iconWrapper.classList.remove("rotate-180"));
        }
    });

    lucide.createIcons();
    updateDashboard(allYears[0]);
});
</script>
</body>
</html>

